services:
  auditor:
    build: .
    ports:
      - "8081:8081"
    command: ["-config", "/app/config/config.yaml", "-metrics-addr", ":8081"]
    volumes:
      - ./config:/app/config
    depends_on:
      - postgres
      - elasticsearch
      - ml-service
    environment:
      - POSTGRES_HOST=postgres
      - ELASTICSEARCH_URL=http://elasticsearch:9200

  postgres:
    image: pgvector/pgvector:pg15
    command: ["postgres", "-c", "wal_level=logical"]
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: consistency_db
    ports:
      - "5432:5432"
    volumes:
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql

  elasticsearch:
    image: elasticsearch:8.9.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - "9200:9200"

  ml-service:
    build: 
      context: ./ml_service
      dockerfile: Dockerfile
    container_name: ml-service
    ports:
      - "5000:5000"
      - "5001:5001"
    volumes:
      - ./ml_service/config.yaml:/app/config.yaml
    shm_size: '2gb'
    environment:
      - PYTHONUNBUFFERED=1
      - JAX_PLATFORMS=cpu
      - XLA_PYTHON_CLIENT_MEM_FRACTION=0.10
      - XLA_PYTHON_CLIENT_PREALLOCATE=false
      - XLA_PYTHON_CLIENT_ALLOCATOR=platform
      - OMP_NUM_THREADS=1
      - MKL_NUM_THREADS=1
    restart: on-failure
    # ADD THIS SECTION:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s # Gives the AI model 5 minutes to load
