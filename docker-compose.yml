services:
  auditor:
    build: .
    # Maps the new host port to the new container port
    ports:
      - "8081:8081"
    # Overrides the default CMD to specify the new metrics address
    command: ["-config", "/app/config/config.yaml", "-metrics-addr", ":8081"]
    volumes:
      - ./config:/app/config
    depends_on:
      - postgres
      - elasticsearch
      - ml-service
    environment:
      - POSTGRES_HOST=postgres
      - ELASTICSEARCH_URL=http://elasticsearch:9200

  postgres:
    image: pgvector/pgvector:pg15
    # Required for CDC: enables logical decoding in the Write-Ahead Log
    command: ["postgres", "-c", "wal_level=logical"]
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: consistency_db
    ports:
      - "5432:5432"
    volumes:
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql

  elasticsearch:
    image: elasticsearch:8.9.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - "9200:9200"


  ml-service:
    build: 
      context: ./ml_service
      dockerfile: Dockerfile
    container_name: ml-service
    ports:
      - "5000:5000"
      - "5001:5001"
    volumes:
      - ./ml_service/config.yaml:/app/config.yaml
    
    # --- AMD GPU PASSTHROUGH START ---
    devices:
      - /dev/kfd:/dev/kfd   # Main compute interface
      - /dev/dri:/dev/dri   # Direct Rendering Infrastructure
    group_add:
      - video               # Grant permission to video group
    security_opt:
      - seccomp:unconfined  # Often required for GPU access
    # --- AMD GPU PASSTHROUGH END ---

    environment:
      - JAX_PLATFORMS=rocm  # Changed from 'cpu' to 'rocm'
    restart: on-failure